<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <button class="ws"> Start socket</button>
    <button class="login">Login</button>
    <button class="start-ws">Start WebSocket</button>
    <button class="send-mesage">Send Message</button>
    <button class="go-online">Go online</button>
    <button class="go-offline">Go offline</button>
    <button class="add-vehicle">Add Vehicle</button>
    <button class="get-location">Get Location</button>
    <button class="connect-peer">Connect Peer</button>
    <div class="call">
        <input type="text" class="peer_call_email">
        <button class="call-peer">Call Rider</button>
    </div>
    <div class="call incoming-call hide">
        <strong>Incoming Call</strong>
        <div class="caller-details">
            <p> </p>
        </div>
        <button class="accept-call">Accept Call</button>
        <button class="reject-call">Reject Call</button>
    </div>

    <!-- confirmation alert window -->
    <div class="alert show" role="alert">
        <strong>Success!</strong>
        <button class="yes">Yes</button>
        <button class="no">No</button>
        <button type="button" class="btn-close">X</button>
    </div>
    <!-- Web socket with ws-->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.2/socket.io.js"></script> -->
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

    <!-- Buttons -->
    <script>
        const websocketButton = document.querySelector('.ws');
        const loginButton = document.querySelector('.login');
        const restartWsButton = document.querySelector('.start-ws');
        const sendMessageButton = document.querySelector('.send-mesage');
        const goOnlineButton = document.querySelector('.go-online');
        const goOfflineButton = document.querySelector('.go-offline');
        const addVehicleButton = document.querySelector('.add-vehicle');

        addVehicleButton.addEventListener('click', () => {
            axios.post('http://localhost:5000/api/v1/vehicle/add', {
                name: 'Toyota',
                model: 'Corolla',
                year: 2010,
                color: 'Black',
                manufacturer: 'Toyota',
                plate_number: 'KCK 123',
            }, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem(`access_token:${email}`)}`
                }
            }).then((res) => {
                console.log(res.data)
            }).catch((err) => {
                console.log(err)
            })
        })

        websocketButton.addEventListener('click', () => {
            wss.broadcast('ws:message', "Hi from the client")
            // wss.send('Hello from client');
        });

        sendMessageButton.addEventListener('click', () => {
            wss.broadcast('ws:message', "Hi from the client")
        })

        const email = 'cruiserider16@gmail.com'
        const serverURL = 'http://localhost:5000/api/v1';
        function login() {
            axios.post(`${serverURL}/auth/login`, {
                email,
                password: 'testpassword'
            }).then((res) => {
                console.log(res.data)
                // Extract access token
                const { access_token } = res.data.data;
                localStorage.setItem(`access_token:${email}`, access_token);
            }).catch((err) => {
                console.log(err)
            })
        }
        loginButton.addEventListener('click', login)
    </script>

    <!-- Utils -->
    <script>
        function parseData(data) {
            try {
                const res = JSON.parse(data);
                res.message_type = 'server'

                return res;
            } catch (error) {
                if (error instanceof SyntaxError) {
                    return null;
                }
                throw new Error(error);
            }
        }


    </script>

    <!-- Websocket Custom Methods -->
    <script>
        // Send message back to server
        WebSocket.prototype.broadcast = function (event, data) {
            const message = JSON.stringify({ event, data });
            this.send(message);
        }

        // Emit messages to be handled within
        WebSocket.prototype.emit = function (event, data) {
            let message = data

            const dom_event = new CustomEvent(event, {
                detail: message
            })

            this.dispatchEvent(dom_event)
        }
    </script>

    <!-- Middlewares -->
    <script>
        const wsWrapper = (fn) => {
            return async (data) => {
                try {
                    const response = await fn(data)
                    // wss.emit('backend:message', response)
                } catch (error) {
                    wss.emit('error', error)
                }
            }
        }
    </script>

    <!-- Location -->
    <script>
        const locationButton = document.querySelector('.get-location')

        locationButton.addEventListener('click', () => {
            getLocation().then((res) => {
                console.log(res)
            }).catch((err) => {
                console.log(err)
            })
        })

        function getLocation() {
            return new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject))
        }
    </script>

    <!-- Socket Event handlers -->
    <script>
        let wss;

        function start() {
            const access_token = localStorage.getItem(`access_token:${email}`);
            wss = new WebSocket("ws://localhost:5000/ws", [access_token]);
            globalThis.wss = wss

            wss.onopen = () => {
                console.log('Connected to server');
            }

            wss.onmessage = wsWrapper((info) => {
                console.log('----------------------')

                let req_data = info.data
                const parsed_data = parseData(info.data)
                // console.log(parsed_data)

                // If stringified JSON, parseData will return an object with message_type = 'server'
                if (parsed_data?.message_type === 'server') {
                    // Check if event is specified
                    if (parsed_data.event) {
                        wss.emit(parsed_data.event, parsed_data.data)
                        return
                    }

                    wss.emit('backend:message', parsed_data)
                    return
                }

                wss.emit('backend:message', req_data)
            })

            wss.addEventListener('frontend:message', wsWrapper((data) => {
                console.log('[msg] self: ' + data.detail);
            }))

            wss.addEventListener('backend:message', wsWrapper((data) => {
                console.log('[msg] backend: ')
                console.log(data.detail);
            }))

            wss.addEventListener('ride:request', wsWrapper((data) => {
                console.log('[ride:request] ')
                console.log(data.detail);

                show_alert()
            }))

            wss.addEventListener('ride:accepted', wsWrapper((data) => {
                console.log('[ride:accepted] ')
                console.log(data.detail);
            }))

            wss.addEventListener('ride:cancelled', wsWrapper((data) => {
                console.log('[ride:cancelled] ')
                console.log(data.detail);

                alert('Ride cancelled')
            }))

            wss.addEventListener('', wsWrapper((data) => {

            }))

            wss.addEventListener('', wsWrapper((data) => {

            }))

            wss.addEventListener('', wsWrapper((data) => {

            }))
            wss.addEventListener('', wsWrapper((data) => {

            }))
            wss.addEventListener('', wsWrapper((data) => {

            }))

            wss.onclose = () => {
                console.log('Connection closed');
                setTimeout(start, 1000)
            }
        }

        start()

    </script>

    <script>
        wss.addEventListener('vehicle:goonline', (data) => {
            console.log(data)
            console.log('[vehicle:goonline] ' + data.detail);
        })
    </script>

    <!-- Socket Controls -->
    <script>
        goOnlineButton.addEventListener('click', goOnline)
        goOfflineButton.addEventListener('click', goOffline)

        async function goOnline() {
            const { longitude, latitude } = (await getLocation()).coords

            console.log(`Longitude: ${longitude} | Latitude: ${latitude}`)
            const data = {
                // vehicle_id: "63bf5de1e73732712f4a364a",
                location: {
                    type: "Point",
                    coordinates: [longitude, latitude]
                },
            }

            wss.broadcast('rider:goonline', data)
        }

        async function goOffline() {
            const data = {
                vehicle_id: "63bf5de1e73732712f4a364a",
            }

            wss.broadcast('rider:gooffline', data)
        }
    </script>

    <!-- Error handler -->
    <script>
        wss.addEventListener('error', (data) => {
            console.log('[error] ' + data.detail);
        })
    </script>

    <!-- WebRTC -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.20/peer.min.js"></script>
    <script>
        const peer = new Peer()
        let peer_id;
        let conn_peer_id;

        peer.on('open', (id) => {
            console.log('Peer ID: ' + id)
            peer_id = id
            // const conn = peer.connect('6107862e-61a7-4c06-8a26-578030a355bb')
        })

        peer.on('connection', (conn) => {
            console.log('Connected to peer')
            conn.on('data', (data) => {
                console.log(data)
            })
        })

        peer.on('error', (err) => {
            console.log('---Peer connection error---')
            console.log(err)
        })

        const connectButton = document.querySelector('.connect-peer')
        connectButton.addEventListener('click', () => {
            const conn = peer.connect(conn_peer_id)
            conn.on('open', () => {
                conn.send('Hello!')
            })
        })

        function handleCallOfflineResponse(data) {
            // console.log(data)
            const random = Math.floor(Math.random() * 10)
            console.log('Rider is offline' + random)
            closeCallEventListeners()
        }

        function handleCallAcceptedResponse(data) {
            // console.log(data)
            alert('Call accepted')
            conn_peer_id = data.detail.peer_id
            const conn = peer.connect(conn_peer_id)
            const call = peer.call(conn_peer_id, navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }))

            call.on('stream', (stream) => {
                const video = document.querySelector('.video')
                video.srcObject = stream
                video.play()
            })
            closeCallEventListeners()
        }

        function handleCallDeclinedResponse(data) {
            // console.log(data)
            alert('Call declined')
            closeCallEventListeners()
        }
        
        function startCallEventListeners () {
            // Add new listeners
            wss.addEventListener('call:offline', handleCallOfflineResponse)
            wss.addEventListener('call:accepted', handleCallAcceptedResponse)
            wss.addEventListener('call:declined', handleCallDeclinedResponse)
        }

        function closeCallEventListeners () {
            wss.removeEventListener('call:offline', handleCallOfflineResponse)
            wss.removeEventListener('call:accepted', handleCallAcceptedResponse)
            wss.removeEventListener('call:declined', handleCallDeclinedResponse)
        }
        
        function refreshCallEventListeners () {
            closeCallEventListeners()
            startCallEventListeners()
        }

        const callButton = document.querySelector('.call-peer')
        callButton.addEventListener('click', () => {
            // Get rider email from input
            const rider_email = document.querySelector('.peer_call_email').value

            // Get rider peer id from server
            const peer_data = {
                rider_email: rider_email,
                peer_id: peer_id
            }

            refreshCallEventListeners()

            wss.broadcast('call:rider:init', peer_data)
        })

        wss.addEventListener('call:incoming', (data) => {
            alert('Call incoming')
            const caller = data.detail.caller
            const caller_peer_id = data.detail.peer_id

            const incoming_call_pane = document.querySelector('.incoming-call')
            const user_html = `${JSON.stringify(caller)}`
            incoming_call_pane.classList.remove('hide')
            incoming_call_pane.classList.add('show')
            incoming_call_pane.querySelector('.caller-details p').innerHTML = user_html

            const accept_call_button = document.querySelector('.accept-call')
            const decline_call_button = document.querySelector('.reject-call')

            accept_call_button.addEventListener('click', () => {
                const call_data = {
                    peer_id: peer_id,
                }
                wss.broadcast('call:accepted', call_data)

                incoming_call_pane.classList.add('hide')
            })
            decline_call_button.addEventListener('click', () => {
                const call_data = {
                    message: 'Call declined',
                }
                wss.broadcast('call:declined', call_data)

                incoming_call_pane.classList.add('hide')
            })

            console.log(data)

            conn_peer_id = data.detail.peer_id
            const call_connection = peer.connect(conn_peer_id)

            call_connection.on('open', () => {
                call_connection.send('Hello!')
                const call = peer.call(conn_peer_id, navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                }))
            })
        })

    </script>


    <!-- JS script -->
    <script src="./js/script.js"></script>
</body>

</html>
